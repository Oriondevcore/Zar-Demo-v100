<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orion Hotel | Manager Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="./config.js"></script>
    <style>
        :root { --primary: #1a365d; --accent: #3b82f6; --bg: #f4f7f6; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        .brand { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
        .logo-img { height: 35px; border-radius: 4px; }
        .brand-text { font-size: 18px; font-weight: 800; letter-spacing: 1px; }
        .menu { flex: 1; padding: 20px 0; }
        .menu-item { 
            padding: 15px 30px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            color: #cfd8dc; 
            transition: 0.2s; 
            border-left: 4px solid transparent; 
        }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .menu-item.active { background: rgba(255,255,255,0.1); border-left-color: var(--accent); color: white; font-weight: 600; }
        .sidebar-footer { padding: 20px; font-size: 0.75rem; color: rgba(255,255,255,0.4); text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }

        /* Main Area */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h2 { font-size: 26px; font-weight: 700; color: var(--primary); margin: 0; }
        
        .btn { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: 0.2s; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
        }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-group { display: flex; gap: 10px; }

        /* Health Panel */
        .health-panel { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
        }
        .health-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--primary); }
        .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .health-item { 
            padding: 12px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .health-icon { font-size: 1.5rem; }
        .health-icon.online { color: #27ae60; }
        .health-icon.offline { color: #e74c3c; }
        .health-icon.warning { color: #f39c12; }
        .health-info { flex: 1; }
        .health-label { font-size: 0.75rem; color: #7f8c8d; text-transform: uppercase; }
        .health-value { font-size: 0.95rem; font-weight: 600; color: #2c3e50; }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); 
            overflow: hidden; 
            border: 1px solid #eee; 
            transition: transform 0.2s; 
            cursor: pointer; 
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        .card-status-bar { height: 6px; }
        .card.open .card-status-bar { background: #f39c12; }
        .card.urgent .card-status-bar { background: #e74c3c; }
        .card.completed .card-status-bar { background: #27ae60; }

        .card-body { padding: 20px; }
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            color: #7f8c8d; 
            font-size: 0.85rem; 
            font-weight: 600; 
        }
        .main-info { font-size: 1.2rem; font-weight: 700; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .sub-info { font-size: 0.95rem; color: #555; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .meta-info { 
            font-size: 0.9rem; 
            color: #777; 
            margin-top: 12px; 
            padding-top: 12px; 
            border-top: 1px dashed #eee; 
            font-style: italic; 
        }
        .icon-box { color: var(--accent); width: 20px; text-align: center; }

        .status-badge { 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: 600; 
        }
        .status-badge.open { background: #fff3cd; color: #856404; }
        .status-badge.completed { background: #d4edda; color: #155724; }
        .status-badge.urgent { background: #f8d7da; color: #721c24; }

        /* Analytics */
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
        }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.9rem; color: #7f8c8d; margin-top: 5px; }

        .chart-container { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
            margin-bottom: 20px; 
        }
        .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--primary); }

        .loader { display: none; text-align: center; padding: 50px; color: #bdc3c7; }
        .empty-state { text-align: center; padding: 50px; color: #7f8c8d; font-style: italic; }

        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
        }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            max-width: 400px; 
            width: 90%; 
        }
        .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--primary); }
        .modal-btn-group { display: flex; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">
            <img src="./orion-hotel-logo.png" alt="Logo" class="logo-img" id="sidebar-logo">
            <div class="brand-text" id="sidebar-brand">ORION HOTEL</div>
        </div>
        
        <div class="menu">
            <div class="menu-item active" onclick="loadTab('RESTAURANT RESERVATIONS', 'Dining Bookings')">
                <i class="fas fa-utensils"></i> <span>Dining</span>
            </div>
            <div class="menu-item" onclick="loadTab('HOUSEKEEPING', 'Housekeeping')">
                <i class="fas fa-broom"></i> <span>Housekeeping</span>
            </div>
            <div class="menu-item" onclick="loadTab('MAINTENANCE', 'Maintenance')">
                <i class="fas fa-tools"></i> <span>Maintenance</span>
            </div>
            <div class="menu-item" onclick="loadTab('HOTEL RESERVATIONS', 'Room Bookings')">
                <i class="fas fa-bed"></i> <span>Room Bookings</span>
            </div>
            <div class="menu-item" onclick="loadTab('ANALYTICS', 'Analytics')">
                <i class="fas fa-chart-line"></i> <span>Analytics</span>
            </div>
            <div class="menu-item" onclick="loadTab('SYSTEM', 'System Health')">
                <i class="fas fa-heartbeat"></i> <span>System Health</span>
            </div>
        </div>

        <div class="sidebar-footer">
            Powered by <i class="fas fa-bolt"></i> <strong>Gemini 2.0 Flash</strong>
        </div>
    </div>

    <div class="main">
        <header>
            <h2 id="page-title">Dining Bookings</h2>
            <div class="btn-group">
                <button class="btn" onclick="fetchData()"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="btn" onclick="toggleFilter()"><i class="fas fa-filter"></i> <span id="filter-text">Show All</span></button>
            </div>
        </header>

        <div id="health-section"></div>
        <div id="analytics-section"></div>

        <div class="loader" id="loader"><i class="fas fa-circle-notch fa-spin"></i> Loading data...</div>
        <div class="grid" id="data-grid"></div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal" id="status-modal">
        <div class="modal-content">
            <div class="modal-title">Update Ticket Status</div>
            <p id="modal-info"></p>
            <div class="modal-btn-group">
                <button class="btn" onclick="updateStatus('Open')">Open</button>
                <button class="btn" onclick="updateStatus('In Progress')">In Progress</button>
                <button class="btn" onclick="updateStatus('Completed')" style="background:#27ae60">Completed</button>
            </div>
            <button class="btn" onclick="closeModal()" style="background:#95a5a6; margin-top:10px; width:100%">Cancel</button>
        </div>
    </div>

    <script>
        // Load Config
        const CONFIG = typeof HOTEL_CONFIG !== 'undefined' ? HOTEL_CONFIG : {
            branding: { name: "Orion Hotel", logo: "./orion-hotel-logo.png" },
            system: { backend: { scriptUrl: "" } }
        };

        // Apply branding
        document.getElementById('sidebar-brand').innerText = CONFIG.branding.name.toUpperCase();
        document.getElementById('sidebar-logo').src = CONFIG.branding.logo;
        document.title = CONFIG.branding.name + " | Dashboard";

        // API URL
        const API_URL = CONFIG.system.backend.scriptUrl || "https://script.google.com/macros/s/AKfycbwQb7bOHwfMQc-L_gqnw_7nLSK2F9iT8cQafTM5fZ-rT6f3tBeJ9ZDjy0AalZ3-I7_m6Q/exec";
        
        let currentTab = 'RESTAURANT RESERVATIONS';
        let currentFilter = 'all';
        let selectedRow = null;

        function loadTab(tabName, title) {
            currentTab = tabName;
            document.getElementById('page-title').innerText = title;
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Clear sections
            document.getElementById('health-section').innerHTML = '';
            document.getElementById('analytics-section').innerHTML = '';
            
            if (tabName === 'ANALYTICS') {
                loadAnalytics();
            } else if (tabName === 'SYSTEM') {
                loadSystemHealth();
            } else {
                fetchData();
            }
        }

        function toggleFilter() {
            currentFilter = currentFilter === 'all' ? 'open' : 'all';
            document.getElementById('filter-text').innerText = currentFilter === 'all' ? 'Show All' : 'Open Only';
            fetchData();
        }

        async function fetchData() {
            const grid = document.getElementById('data-grid');
            const loader = document.getElementById('loader');
            
            grid.innerHTML = '';
            loader.style.display = 'block';

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "fetch_data", tab: currentTab, filter: currentFilter })
                });
                const json = await response.json();
                
                if (json.status === 'success') {
                    renderData(json.data);
                }
            } catch (error) {
                grid.innerHTML = '<div class="empty-state">‚ùå Failed to connect to system</div>';
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderData(rows) {
            const grid = document.getElementById('data-grid');
            if (!rows || rows.length < 2) {
                grid.innerHTML = '<div class="empty-state">No tickets found</div>';
                return;
            }

            const dataRows = rows.slice(1).reverse();

            dataRows.forEach((row, idx) => {
                const statusCol = getStatusCol(currentTab);
                const status = statusCol >= 0 && row[statusCol] ? row[statusCol].toLowerCase() : 'open';
                const statusClass = status.includes('complete') || status.includes('confirmed') ? 'completed' : 
                                   status.includes('urgent') ? 'urgent' : 'open';
                
                const dateStr = row[0] ? new Date(row[0]).toLocaleString('en-ZA', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                }) : "N/A";
                
                let bodyHtml = '';

                if (currentTab === 'RESTAURANT RESERVATIONS') {
                    bodyHtml = `
                        <div class="main-info"><i class="fas fa-user icon-box"></i> ${row[1]} <span style="font-size:0.8em; color:#777;">(${row[3]} ppl)</span></div>
                        <div class="sub-info"><i class="far fa-clock icon-box"></i> <strong>Time:</strong> ${row[4]}</div>
                        <div class="sub-info"><i class="fas fa-phone icon-box"></i> ${row[2]}</div>
                        ${row[6] ? `<div class="meta-info">"${row[6]}"</div>` : ''}
                    `;
                } 
                else if (currentTab === 'HOUSEKEEPING') {
                    bodyHtml = `
                        <div class="main-info"><i class="fas fa-door-closed icon-box"></i> Room ${row[1]}</div>
                        <div class="sub-info"><i class="fas fa-user icon-box"></i> ${row[2]}</div>
                        <div class="meta-info"><strong>Request:</strong> ${row[3]}</div>
                    `;
                }
                else if (currentTab === 'MAINTENANCE') {
                    bodyHtml = `
                        <div class="main-info"><i class="fas fa-tools icon-box"></i> Room ${row[2]}</div>
                        <div class="sub-info"><i class="fas fa-user icon-box"></i> ${row[1]}</div>
                        <div class="meta-info"><strong>Issue:</strong> ${row[3]}</div>
                    `;
                }
                else if (currentTab === 'HOTEL RESERVATIONS') {
                    bodyHtml = `
                        <div class="main-info"><i class="fas fa-suitcase icon-box"></i> ${row[1]}</div>
                        <div class="sub-info"><i class="far fa-calendar-alt icon-box"></i> ${row[6]} (${row[7]} nights)</div>
                        <div class="sub-info"><i class="fas fa-phone icon-box"></i> ${row[2]}</div>
                        <div class="meta-info">Pax: ${row[5]} | Email: ${row[3]}</div>
                    `;
                }

                const card = `
                    <div class="card ${statusClass}" onclick="openStatusModal(${idx + 2})">
                        <div class="card-status-bar"></div>
                        <div class="card-body">
                            <div class="card-header">
                                <span class="status-badge ${statusClass}">${status.toUpperCase()}</span>
                                <span>${dateStr}</span>
                            </div>
                            ${bodyHtml}
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
        }

        function openStatusModal(rowIndex) {
            selectedRow = rowIndex;
            document.getElementById('modal-info').innerText = `Update status for row ${rowIndex}`;
            document.getElementById('status-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('status-modal').style.display = 'none';
            selectedRow = null;
        }

        async function updateStatus(newStatus) {
            if (!selectedRow) return;

            try {
                await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "update_status",
                        tab: currentTab,
                        rowIndex: selectedRow,
                        newStatus: newStatus
                    })
                });
                closeModal();
                fetchData();
            } catch (error) {
                alert("Failed to update status");
            }
        }

        async function loadAnalytics() {
            const section = document.getElementById('analytics-section');
            section.innerHTML = '<div class="loader"><i class="fas fa-circle-notch fa-spin"></i> Loading analytics...</div>';

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_analytics", range: 7 })
                });
                const json = await response.json();

                if (json.status === 'success') {
                    renderAnalytics(json.analytics);
                }
            } catch (error) {
                section.innerHTML = '<div class="empty-state">Failed to load analytics</div>';
            }
        }

        function renderAnalytics(data) {
            const section = document.getElementById('analytics-section');
            
            section.innerHTML = `
                <div class="analytics-grid">
                    <div class="stat-card">
                        <div class="stat-value">${data.total || 0}</div>
                        <div class="stat-label">Total Requests (7 days)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.open || 0}</div>
                        <div class="stat-label">Open Tickets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.completed || 0}</div>
                        <div class="stat-label">Completed Tickets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0}%</div>
                        <div class="stat-label">Completion Rate</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Requests by Type</div>
                    <canvas id="typeChart" height="80"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Requests by Hour</div>
                    <canvas id="hourlyChart" height="80"></canvas>
                </div>
            `;

            // Render charts
            new Chart(document.getElementById('typeChart'), {
                type: 'pie',
                data: {
                    labels: ['Restaurant', 'Housekeeping', 'Maintenance', 'Room Bookings'],
                    datasets: [{
                        data: [
                            data.byType.restaurant || 0,
                            data.byType.housekeeping || 0,
                            data.byType.maintenance || 0,
                            data.byType.bookings || 0
                        ],
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6']
                    }]
                }
            });

            new Chart(document.getElementById('hourlyChart'), {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'Requests',
                        data: data.hourly || [],
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        async function loadSystemHealth() {
            const section = document.getElementById('health-section');
            section.innerHTML = '<div class="loader"><i class="fas fa-circle-notch fa-spin"></i> Checking system health...</div>';

            try {
                const response = await fetch(API_URL + '?action=health');
                const health = await response.json();

                section.innerHTML = `
                    <div class="health-panel">
                        <div class="health-title">üè• System Status</div>
                        <div class="health-grid">
                            <div class="health-item">
                                <i class="fas fa-brain health-icon ${health.services.gemini === 'online' ? 'online' : 'offline'}"></i>
                                <div class="health-info">
                                    <div class="health-label">Gemini AI</div>
                                    <div class="health-value">${health.services.gemini || 'Unknown'}</div>
                                </div>
                            </div>
                            <div class="health-item">
                                <i class="fas fa-table health-icon ${health.services.sheets === 'online' ? 'online' : 'offline'}"></i>
                                <div class="health-info">
                                    <div class="health-label">Google Sheets</div>
                                    <div class="health-value">${health.services.sheets || 'Unknown'}</div>
                                </div>
                            </div>
                            <div class="health-item">
                                <i class="fab fa-discord health-icon ${health.services.discord > 0 ? 'online' : 'warning'}"></i>
                                <div class="health-info">
                                    <div class="health-label">Discord Webhooks</div>
                                    <div class="health-value">${health.services.discord || 0} Active</div>
                                </div>
                            </div>
                            <div class="health-item">
                                <i class="fas fa-clock health-icon online"></i>
                                <div class="health-info">
                                    <div class="health-label">System Version</div>
                                    <div class="health-value">${health.version || '2.0'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                section.innerHTML = '<div class="empty-state">‚ùå Failed to check system health</div>';
            }
        }

        function getStatusCol(tab) {
            const cols = {
                "RESTAURANT RESERVATIONS": 8,
                "HOUSEKEEPING": 4,
                "MAINTENANCE": 5,
                "HOTEL RESERVATIONS": 9
            };
            return cols[tab] !== undefined ? cols[tab] : -1;
        }

        // Initial load
        fetchData();
    </script>
</body>
</html>
